<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>LoterÃ­a del Grupo</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

<!-- CONTENEDOR PRINCIPAL -->
<div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6">
  <h1 class="text-3xl font-bold text-center mb-4 text-blue-600">ðŸ’° LoterÃ­a del Grupo</h1>

  <!-- BOTONES ADMIN -->
  <div class="flex justify-end mb-4 space-x-2">
    <button id="adminBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Entrar como Admin</button>
    <button id="logoutBtn" class="hidden bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">Salir</button>
  </div>

  <!-- INFORMACIÃ“N -->
  <div class="grid grid-cols-2 gap-4 mb-6 text-center">
    <div class="bg-blue-50 rounded-xl p-4">
      <p class="text-gray-500">Saldo Total</p>
      <p id="saldoTotal" class="text-2xl font-bold text-blue-600">0â‚¬</p>
    </div>
    <div class="bg-yellow-50 rounded-xl p-4">
      <p class="text-gray-500">Premio</p>
      <p id="premioTotal" class="text-2xl font-bold text-yellow-600">0â‚¬</p>
    </div>
  </div>

  <p class="text-center text-gray-600 mb-4">Semana actual: <span id="fechaSemana" class="font-semibold"></span></p>

  <!-- TABLA -->
  <div class="overflow-x-auto mb-4">
    <table class="w-full border rounded-xl overflow-hidden">
      <thead>
        <tr class="bg-gray-200">
          <th class="border px-2 py-2">Nombre</th>
          <th class="border px-2 py-2">Saldo (â‚¬)</th>
          <th class="border px-2 py-2 admin-only hidden">Acciones</th>
        </tr>
      </thead>
      <tbody id="miembrosTable"></tbody>
    </table>
  </div>

  <!-- BOTONES ADMIN -->
  <div class="flex justify-between mb-4 admin-only hidden">
    <button id="addMemberBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">AÃ±adir Miembro</button>
    <button id="playWeekBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">Jugar Semana</button>
    <button id="editPrizeBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">Editar Premio</button>
  </div>

  <!-- HISTORIAL -->
  <h2 class="text-xl font-bold mb-2">ðŸ“œ Historial</h2>
  <div id="historial" class="border rounded-lg p-3 h-40 overflow-y-scroll bg-gray-50 mb-3"></div>
  <button id="downloadCSV" class="w-full bg-gray-600 hover:bg-gray-800 text-white px-4 py-2 rounded-lg">Descargar CSV</button>
</div>

<!-- Firebase SDK y App -->
<script type="module">
  // âœ… Importar Firebase Modular
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import { getFirestore, doc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

  // âœ… ConfiguraciÃ³n Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDXejcJRXVXy4sJhnMKTIPaBhDHAWVUVkc",
    authDomain: "penadelcasi.firebaseapp.com",
    projectId: "penadelcasi",
    storageBucket: "penadelcasi.firebasestorage.app",
    messagingSenderId: "400877033442",
    appId: "1:400877033442:web:db6fbdded6b099ac084bbb",
    measurementId: "G-WQCGW2VW7D"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // âœ… Elementos del DOM
  const adminBtn = document.getElementById('adminBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const miembrosTable = document.getElementById('miembrosTable');
  const saldoTotalEl = document.getElementById('saldoTotal');
  const premioTotalEl = document.getElementById('premioTotal');
  const fechaSemanaEl = document.getElementById('fechaSemana');
  const historialDiv = document.getElementById('historial');
  const addMemberBtn = document.getElementById('addMemberBtn');
  const playWeekBtn = document.getElementById('playWeekBtn');
  const editPrizeBtn = document.getElementById('editPrizeBtn');
  const downloadCSVBtn = document.getElementById('downloadCSV');

  let isAdmin = false;
  let grupoData = {};
  const docRef = doc(db, 'loteria', 'grupo');

  function toggleAdminUI() {
    document.querySelectorAll('.admin-only').forEach(el => {
      el.classList.toggle('hidden', !isAdmin);
    });
    adminBtn.classList.toggle('hidden', isAdmin);
    logoutBtn.classList.toggle('hidden', !isAdmin);
  }

  function renderUI() {
    miembrosTable.innerHTML = '';
    let total = 0;
    grupoData.miembros.forEach((m, index) => {
      total += m.saldo;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border px-2 py-1">${m.nombre}</td>
        <td class="border px-2 py-1">${m.saldo.toFixed(2)}</td>
        <td class="border px-2 py-1 admin-only ${isAdmin ? '' : 'hidden'}">
          <button class="bg-red-500 text-white px-2 rounded" onclick="deleteMember(${index})">X</button>
        </td>
      `;
      miembrosTable.appendChild(tr);
    });
    saldoTotalEl.textContent = total.toFixed(2) + 'â‚¬';
    premioTotalEl.textContent = grupoData.premio.toFixed(2) + 'â‚¬';
    fechaSemanaEl.textContent = new Date().toLocaleDateString('es-ES');
    historialDiv.innerHTML = grupoData.historial.slice().reverse().map(h => `<p>${h}</p>`).join('');
  }

  // âœ… Escuchar cambios en Firestore
  onSnapshot(docRef, (snap) => {
    if (snap.exists()) {
      grupoData = snap.data();
      renderUI();
    }
  });

  // âœ… Funciones Admin
  adminBtn.addEventListener('click', async () => {
    const pass = prompt('Introduce la clave de admin:');
    if (!pass) return;
    const snap = await getDoc(docRef);
    if (snap.exists() && snap.data().adminKey === pass) {
      isAdmin = true;
      toggleAdminUI();
    } else {
      alert('Clave incorrecta');
    }
  });

  logoutBtn.addEventListener('click', () => {
    isAdmin = false;
    toggleAdminUI();
  });

  // AÃ±adir miembro
addMemberBtn.addEventListener('click', async () => {
  const nombre = prompt('Nombre del miembro:');
  const saldo = parseFloat(prompt('Saldo inicial (â‚¬):'));
  if (!nombre || isNaN(saldo)) return;

  grupoData.miembros = [...grupoData.miembros, { nombre, saldo }];
  grupoData.historial = [
    `${new Date().toLocaleString()} - AÃ±adido: ${nombre} (${saldo}â‚¬)`,
    ...grupoData.historial
  ];

  await updateDoc(docRef, {
    miembros: grupoData.miembros,
    historial: grupoData.historial,
  });
});

  

  window.deleteMember = async (index) => {
    const eliminado = grupoData.miembros[index];
    grupoData.miembros.splice(index, 1);
    grupoData.historial.push(`${new Date().toLocaleString()} - Eliminado: ${eliminado.nombre}`);
    await updateDoc(docRef, grupoData);
  };

  playWeekBtn.addEventListener('click', async () => {
    grupoData.miembros.forEach(m => m.saldo -= 1);
    grupoData.historial.push(`${new Date().toLocaleString()} - Semana jugada (-1â‚¬ a cada uno)`);
    await updateDoc(docRef, grupoData);
  });

  editPrizeBtn.addEventListener('click', async () => {
    const nuevo = parseFloat(prompt('Nuevo premio (â‚¬):'));
    if (isNaN(nuevo)) return;
    grupoData.historial.push(`${new Date().toLocaleString()} - Premio: ${grupoData.premio}â‚¬ â†’ ${nuevo}â‚¬`);
    grupoData.premio = nuevo;
    await updateDoc(docRef, grupoData);
  });

  downloadCSVBtn.addEventListener('click', () => {
    const csv = grupoData.historial.map(h => `"${h}"`).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'historial.csv';
    a.click();
    URL.revokeObjectURL(url);
  });
</script>
</body>
</html>
