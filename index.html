<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>La pe√±a del casi</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
// ============ FIREBASE CONFIG =============
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

// üîπ Configura con tus credenciales Firebase
const firebaseConfig = {
    // üîπ Configura con tus credenciales Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDXejcJRXVXy4sJhnMKTIPaBhDHAWVUVkc",
    authDomain: "penadelcasi.firebaseapp.com",
    projectId: "penadelcasi",
    storageBucket: "penadelcasi.firebasestorage.app",
    messagingSenderId: "400877033442",
    appId: "1:400877033442:web:db6fbdded6b099ac084bbb",
    measurementId: "G-WQCGW2VW7D"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const docRef = doc(db, "loteria", "grupo");

// ============ VARIABLES ============
let data = { miembros: [], premio: 0, historial: [], adminKey: "" };
let isAdmin = false;

// ============ LISTENER FIRESTORE ============
onSnapshot(docRef, (snapshot) => {
    if (snapshot.exists()) {
        data = snapshot.data();
        mostrar();
        mostrarHistorial();
    } else {
        setDoc(docRef, data);
    }
});

async function guardar() {
    await setDoc(docRef, data);
}

// ============ FUNCIONES DE NEGOCIO ============
function agregarMiembro() {
    if (!isAdmin) return;
    const nombre = document.getElementById('nombre').value.trim();
    const saldo = parseFloat(document.getElementById('saldo').value);
    if (nombre && !isNaN(saldo)) {
        data.miembros.push({ nombre, saldo });
        registrarHistorial("A√±adir miembro", `Nombre: ${nombre}, Saldo: ${saldo}‚Ç¨`);
        guardar();
    }
    document.getElementById('nombre').value = '';
    document.getElementById('saldo').value = '0';
}

function eliminarMiembro(i) {
    if (!isAdmin) return;
    const eliminado = data.miembros[i].nombre;
    registrarHistorial("Eliminar miembro", `Nombre: ${eliminado}`);
    data.miembros.splice(i, 1);
    guardar();
}

function editarSaldo(i, valor) {
    if (!isAdmin) return;
    const anterior = data.miembros[i].saldo;
    const nuevo = parseFloat(valor);
    data.miembros[i].saldo = nuevo;
    registrarHistorial("Editar saldo", `${data.miembros[i].nombre}: ${anterior}‚Ç¨ ‚Üí ${nuevo}‚Ç¨`);
    guardar();
}

function editarPremio(valor) {
    if (!isAdmin) return;
    const anterior = data.premio;
    const nuevo = parseFloat(valor);
    data.premio = nuevo;
    registrarHistorial("Editar premio", `${anterior}‚Ç¨ ‚Üí ${nuevo}‚Ç¨`);
    guardar();
}

function jugarSemana() {
    if (!isAdmin) return;
    let saldoAntes = totalSaldo();
    data.miembros = data.miembros.map(m => {
        if (m.saldo >= 1) m.saldo -= 1;
        return m;
    });
    let saldoDespues = totalSaldo();
    registrarHistorial("Jugar semana", `Saldo total: ${saldoAntes}‚Ç¨ ‚Üí ${saldoDespues}‚Ç¨ (-1‚Ç¨ a cada miembro)`);
    guardar();
}

function registrarHistorial(accion, detalles) {
    const fecha = new Date().toLocaleString('es-ES');
    data.historial.unshift({ fecha, accion, detalles });
}

// ============ FUNCIONES UI ============
function mostrar() {
    const tabla = document.getElementById('tabla');
    tabla.innerHTML = '';
    let total = 0;
    data.miembros.forEach((m, i) => {
        total += m.saldo;
        tabla.innerHTML += `
            <tr>
                <td class="border p-2">${m.nombre}</td>
                <td class="border p-2">
                    ${isAdmin
                        ? `<input type="number" value="${m.saldo}" onchange="editarSaldo(${i}, this.value)" class="border rounded p-1 w-20 text-center">`
                        : `${m.saldo.toFixed(2)}`
                    }
                </td>
                <td class="border p-2">
                    ${isAdmin ? `<button onclick="eliminarMiembro(${i})" class="bg-red-400 text-white px-2 py-1 rounded">Eliminar</button>` : ''}
                </td>
            </tr>`;
    });
    document.getElementById('saldoTotal').textContent = total.toFixed(2);
    document.getElementById('premio').value = data.premio;
    document.getElementById('adminBadge').style.display = isAdmin ? 'inline' : 'none';
}

function mostrarHistorial() {
    const lista = document.getElementById('historial');
    lista.innerHTML = '';
    data.historial.forEach(item => {
        lista.innerHTML += `
            <li class="border-b py-1 text-sm">
                <strong>${item.fecha}</strong> - ${item.accion}<br>
                <span class="text-gray-600">${item.detalles}</span>
            </li>`;
    });
}

function totalSaldo() {
    return data.miembros.reduce((sum, m) => sum + m.saldo, 0).toFixed(2);
}

// ============ ADMIN LOGIN ============
window.loginAdmin = async function() {
    const clave = prompt("Introduce la clave de administrador:");
    if (clave === data.adminKey) {
        isAdmin = true;
        mostrar();
    } else {
        alert("Clave incorrecta");
    }
}

window.logoutAdmin = function() {
    isAdmin = false;
    mostrar();
}

// ============ CSV EXPORT ============
window.exportarCSV = function() {
    let csv = "Fecha,Acci√≥n,Detalles\n";
    data.historial.forEach(item => {
        csv += `"${item.fecha}","${item.accion}","${item.detalles}"\n`;
    });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.setAttribute("download", "historial_loteria.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Exponer funciones a ventana
window.agregarMiembro = agregarMiembro;
window.eliminarMiembro = eliminarMiembro;
window.editarSaldo = editarSaldo;
window.editarPremio = editarPremio;
window.jugarSemana = jugarSemana;

</script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
<div class="max-w-5xl mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">üé∞ Loter√≠a del Grupo <span id="adminBadge" class="text-sm bg-yellow-400 px-2 py-1 rounded hidden">Admin</span></h1>
        <div>
            <button onclick="loginAdmin()" class="bg-blue-500 text-white px-3 py-1 rounded">Entrar como Admin</button>
            <button onclick="logoutAdmin()" class="bg-gray-400 text-white px-3 py-1 rounded">Salir</button>
        </div>
    </div>

    <div class="bg-white shadow rounded-lg p-4 mb-6">
        <p class="text-lg">üìÖ Hoy es: <span id="fecha"></span></p>
        <p class="text-lg mt-2">üí∞ Total quemable: <span id="saldoTotal" class="font-bold text-green-600">0</span> ‚Ç¨</p>
        <p class="text-lg mt-2">üèÜ La jubilaci√≥n: 
            <input type="number" id="premio" class="border rounded p-1 w-24 text-center" onchange="editarPremio(this.value)" ${isAdmin ? '' : 'disabled'}> ‚Ç¨
        </p>
    </div>

    <div id="adminControls" class="${isAdmin ? '' : 'hidden'}">
        <div class="bg-white shadow rounded-lg p-4 mb-4">
            <h2 class="text-xl font-semibold mb-2">‚ûï A√±adir Miembro</h2>
            <div class="flex gap-2">
                <input type="text" id="nombre" placeholder="Nombre" class="border rounded p-2 w-1/2">
                <input type="number" id="saldo" placeholder="Saldo (‚Ç¨)" class="border rounded p-2 w-1/3" value="0">
                <button onclick="agregarMiembro()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">A√±adir</button>
            </div>
        </div>

        <div class="mt-6 flex flex-wrap gap-2 justify-center">
            <button onclick="jugarSemana()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Jugar Semana</button>
        </div>
    </div>

    <div class="bg-white shadow rounded-lg p-4 mt-6">
        <h2 class="text-xl font-semibold mb-4">üë• Miembros</h2>
        <table class="w-full text-center border-collapse">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border p-2">Nombre</th>
                    <th class="border p-2">Saldo (‚Ç¨)</th>
                    <th class="border p-2">Acciones</th>
                </tr>
            </thead>
            <tbody id="tabla"></tbody>
        </table>
    </div>

    <div class="bg-white shadow rounded-lg p-4 mt-6">
        <h2 class="text-xl font-semibold mb-4">üìú Historial</h2>
        <div class="max-h-64 overflow-y-auto border p-2 rounded bg-gray-50">
            <ul id="historial" class="list-disc pl-4"></ul>
        </div>
        <button onclick="exportarCSV()" class="mt-3 bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">Descargar CSV</button>
    </div>
</div>

<script>
document.getElementById('fecha').textContent = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
</script>
</body>
</html>
