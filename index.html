<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>La peña del casi</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6">
  <h1 class="text-3xl font-bold mb-4 text-center">Lotería del Grupo</h1>

  <div class="flex justify-between mb-4">
    <button id="adminBtn" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded">Entrar como Admin</button>
    <button id="logoutBtn" class="hidden bg-gray-500 hover:bg-gray-700 text-white px-4 py-2 rounded">Salir Admin</button>
  </div>

  <div class="mb-4 flex justify-between">
    <div>
      <p><strong>Total quemable:</strong> <span id="saldoTotal">0€</span></p>
      <p><strong>La jubilación</strong> <span id="premioTotal">0€</span></p>
    </div>
    <div>
      <p><strong>Semana Actual:</strong> <span id="fechaSemana"></span></p>
    </div>
  </div>

  <table class="w-full table-auto border-collapse mb-4">
    <thead>
      <tr class="bg-gray-200">
        <th class="border px-2 py-1">Nombre</th>
        <th class="border px-2 py-1">Saldo (€)</th>
        <th class="border px-2 py-1 admin-only hidden">Acciones</th>
      </tr>
    </thead>
    <tbody id="miembrosTable"></tbody>
  </table>

  <div class="flex justify-between mb-4 admin-only hidden">
    <button id="addMemberBtn" class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded">Añadir Miembro</button>
    <button id="playWeekBtn" class="bg-purple-500 hover:bg-purple-700 text-white px-4 py-2 rounded">Jugar Semana</button>
    <button id="editPrizeBtn" class="bg-yellow-500 hover:bg-yellow-700 text-white px-4 py-2 rounded">Editar Premio</button>
  </div>

  <h2 class="text-xl font-bold mb-2">Historial</h2>
  <div class="border rounded p-2 h-40 overflow-y-scroll bg-gray-50" id="historial"></div>
  <button id="downloadCSV" class="mt-3 bg-gray-600 hover:bg-gray-800 text-white px-4 py-2 rounded">Descargar CSV</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js"></script>

<script>
  // ✅ Configuración Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDXejcJRXVXy4sJhnMKTIPaBhDHAWVUVkc",
    authDomain: "penadelcasi.firebaseapp.com",
    projectId: "penadelcasi",
    storageBucket: "penadelcasi.firebasestorage.app",
    messagingSenderId: "400877033442",
    appId: "1:400877033442:web:db6fbdded6b099ac084bbb",
    measurementId: "G-WQCGW2VW7D"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const adminBtn = document.getElementById('adminBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const miembrosTable = document.getElementById('miembrosTable');
  const saldoTotalEl = document.getElementById('saldoTotal');
  const premioTotalEl = document.getElementById('premioTotal');
  const fechaSemanaEl = document.getElementById('fechaSemana');
  const historialDiv = document.getElementById('historial');
  const addMemberBtn = document.getElementById('addMemberBtn');
  const playWeekBtn = document.getElementById('playWeekBtn');
  const editPrizeBtn = document.getElementById('editPrizeBtn');
  const downloadCSVBtn = document.getElementById('downloadCSV');

  let isAdmin = false;
  let grupoData = {};

  const docRef = db.collection('loteria').doc('grupo');

  function toggleAdminUI() {
    document.querySelectorAll('.admin-only').forEach(el => {
      el.classList.toggle('hidden', !isAdmin);
    });
    adminBtn.classList.toggle('hidden', isAdmin);
    logoutBtn.classList.toggle('hidden', !isAdmin);
  }

  // ✅ Actualiza interfaz
  function renderUI() {
    miembrosTable.innerHTML = '';
    let total = 0;
    grupoData.miembros.forEach((m, index) => {
      total += m.saldo;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="border px-2 py-1">${m.nombre}</td>
        <td class="border px-2 py-1">${m.saldo.toFixed(2)}</td>
        <td class="border px-2 py-1 admin-only ${isAdmin ? '' : 'hidden'}">
          <button class="bg-red-500 text-white px-2 rounded" onclick="deleteMember(${index})">X</button>
        </td>
      `;
      miembrosTable.appendChild(row);
    });
    saldoTotalEl.textContent = total.toFixed(2) + '€';
    premioTotalEl.textContent = grupoData.premio.toFixed(2) + '€';
    fechaSemanaEl.textContent = new Date().toLocaleDateString('es-ES');
    historialDiv.innerHTML = grupoData.historial.slice().reverse().map(item => `<p>${item}</p>`).join('');
  }

  // ✅ Escuchar cambios en Firestore
  docRef.onSnapshot(doc => {
    if (doc.exists) {
      grupoData = doc.data();
      renderUI();
    }
  });

  // ✅ Entrar como admin
  adminBtn.addEventListener('click', async () => {
    const pass = prompt('Introduce la clave de admin:');
    if (!pass) return;
    const docSnap = await docRef.get();
    if (docSnap.exists && docSnap.data().adminKey === pass) {
      isAdmin = true;
      toggleAdminUI();
    } else {
      alert('Clave incorrecta');
    }
  });

  logoutBtn.addEventListener('click', () => {
    isAdmin = false;
    toggleAdminUI();
  });

  // ✅ Añadir miembro
  addMemberBtn.addEventListener('click', async () => {
    const nombre = prompt('Nombre del miembro:');
    const saldo = parseFloat(prompt('Saldo inicial (€):'));
    if (!nombre || isNaN(saldo)) return;
    grupoData.miembros.push({ nombre, saldo });
    grupoData.historial.push(`${new Date().toLocaleString()} - Añadido miembro: ${nombre} con saldo ${saldo}€`);
    await docRef.update(grupoData);
  });

  // ✅ Eliminar miembro
  window.deleteMember = async (index) => {
    const eliminado = grupoData.miembros[index];
    grupoData.miembros.splice(index, 1);
    grupoData.historial.push(`${new Date().toLocaleString()} - Eliminado miembro: ${eliminado.nombre}`);
    await docRef.update(grupoData);
  };

  // ✅ Jugar semana
  playWeekBtn.addEventListener('click', async () => {
    grupoData.miembros.forEach(m => m.saldo -= 1);
    grupoData.historial.push(`${new Date().toLocaleString()} - Semana jugada (-1€ a todos)`);
    await docRef.update(grupoData);
  });

  // ✅ Editar premio
  editPrizeBtn.addEventListener('click', async () => {
    const nuevoPremio = parseFloat(prompt('Nuevo premio (€):'));
    if (isNaN(nuevoPremio)) return;
    grupoData.historial.push(`${new Date().toLocaleString()} - Premio cambiado: ${grupoData.premio}€ → ${nuevoPremio}€`);
    grupoData.premio = nuevoPremio;
    await docRef.update(grupoData);
  });

  // ✅ Descargar historial en CSV
  downloadCSVBtn.addEventListener('click', () => {
    const csv = grupoData.historial.map(line => `"${line}"`).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'historial.csv';
    a.click();
    URL.revokeObjectURL(url);
  });
</script>
</body>
</html>
